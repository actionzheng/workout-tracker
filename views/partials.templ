package appviews

import "time"

templ Head() {
	<title>Workout Tracker</title>
	<meta charset="UTF-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<link rel="icon" type="image/png" href={ routeFor(ctx, "assets") + "/dumbbell.png" }/>
	<link href={ routeFor(ctx, "assets") + "/output.css" } rel="stylesheet"/>
	<script src={ routeFor(ctx, "assets") + "/common.js" }></script>
	<script src={ routeFor(ctx, "assets") + "/dist/htmx.min.js" }></script>
	@Theme()
}

templ Theme() {
	switch CurrentUser(ctx).Profile.Theme {
		case "light":
			<script>
        document.documentElement.classList.toggle("dark", false);
      </script>
		case "dark":
			<script>
        document.documentElement.classList.toggle("dark", true);
      </script>
		default:
			<script>
        var browserThemeDark = window.matchMedia(
          "(prefers-color-scheme: dark)",
        ).matches;
        document.documentElement.classList.toggle("dark", browserThemeDark);
      </script>
	}
}

templ SnippetDate(date time.Time) {
	if CurrentUser(ctx).ShowFullDate() {
		<abbr title={ RelativeDate(ctx, date) }>{ LocalDate(ctx, date) }</abbr>
	} else {
		<abbr title={ LocalDate(ctx, date) }>{ RelativeDate(ctx, date) }</abbr>
	}
}

templ Alerts() {
	<div id="alerts" class="messages">
		{{ ns := notices(ctx) }}
		if ns != nil {
			<div class="notice" role="alert">
				for _, n := range ns {
					<span class="block sm:inline">{ n } </span>
				}
			</div>
		}
		{{ es := errors(ctx) }}
		if es != nil {
			<div class="alert" role="alert">
				for _, e := range es {
					<span class="block sm:inline">{ e } </span>
				}
			</div>
		}
	</div>
}

templ Footer() {
	{{ v := version(ctx) }}
	<div class="footer">
		<div>
			Workout Tracker,
			<a
				target="_blank"
				title={ "Build time: " + v.BuildTime }
				href={ templ.SafeURL("https://github.com/jovandeginste/workout-tracker/tree/" + v.Sha) }
			>
				{ v.PrettyVersion() }
			</a>
		</div>
		<div>
			<a
				class="icon-brands icon-baseline icon-space-sm icon-outside icon-github"
				target="_blank"
				href="https://github.com/jovandeginste/workout-tracker"
			>GitHub</a>
		</div>
		<div>
			<a
				class="icon-solid icon-baseline icon-space-sm icon-outside icon-clipboard-check"
				target="_blank"
				href={ templ.SafeURL("https://github.com/jovandeginste/workout-tracker/tree/" + v.Sha + "/CHANGELOG.md") }
			>Changelog</a>
		</div>
	</div>
}

templ Version() {
	{{ v := version(ctx) }}
	{{ currentUser := CurrentUser(ctx) }}
	if currentUser.IsActive() {
		if v.Sha != currentUser.LastVersion {
			<div id="version-notification" class="version-notice max-h-48" role="alert">
				<span class="block sm:inline">
					This application was updated to version: 
					<a
						target="_blank"
						title={ "Build time:" + v.BuildTime }
						href={ templ.SafeURL("https://github.com/jovandeginste/workout-tracker/tree/" + v.Sha) }
					>
						{ v.PrettyVersion() }
					</a>
					. You may find the changes in
					<a
						target="_blank"
						href={ templ.SafeURL("https://github.com/jovandeginste/workout-tracker/tree/" + v.Sha + "/CHANGELOG.md") }
					>the Changelog</a>. (
					<a
						href="#"
						hx-target="#version-notification"
						hx-swap="beforeend"
						hx-post={ routeFor(ctx, "user-update-version") }
					>hide until next update</a>)
				</span>
			</div>
		}
	}
}

templ Language() {
	<select class="border-0" onchange="changeLanguage(this.value)">
		for _, sl := range supportedLanguages(ctx) {
			{{ linf := ToLanguageInformation(sl.String()) }}
			<option value={ linf.Code } selected?={ linf.Code == language(ctx) }>
				{ linf.Flag } { linf.LocalName }
				if linf.EnglishName != "" && linf.EnglishName != linf.LocalName {
					({ linf.EnglishName }) 
				}
			</option>
		}
	</select>
	<script>
    function changeLanguage(value) {
      location.assign("?lang=" + value);
    }
  </script>
}

templ Header() {
	{{ currentUser := CurrentUser(ctx) }}
	<div class="menu md:flex md:flex-wrap gap-4">
		<h1><a href={ templ.SafeURL(routeFor(ctx, "dashboard")) }>Workout Tracker</a> </h1>
		if currentUser.IsActive() {
			<div class="grow flex flex-wrap">
				<div class="grow flex flex-wrap justify-start">
					<div>
						<a href={ templ.SafeURL(routeFor(ctx, "dashboard")) }>
							@IconFor("dashboard")
							<span class="autohide">{ i18n(ctx, "Dashboard") }</span>
						</a>
					</div>
					<div>
						<a href={ templ.SafeURL(routeFor(ctx, "statistics")) }>
							@IconFor("statistics")
							<span class="autohide">{ i18n(ctx, "Statistics") }</span>
						</a>
					</div>
					<div>
						<a href={ templ.SafeURL(routeFor(ctx, "workouts")) }>
							@IconFor("workout")
							<span class="autohide">{ i18n(ctx, "Workouts") }</span>
						</a>
					</div>
					<div>
						<a href={ templ.SafeURL(routeFor(ctx, "route-segments")) }>
							@IconFor("route-segment")
							<span class="autohide">{ i18n(ctx, "Route segments") }</span>
						</a>
					</div>
					<div>
						<a href={ templ.SafeURL(routeFor(ctx, "equipment")) }>
							@IconFor("equipment")
							<span class="autohide">{ i18n(ctx, "Equipment") }</span>
						</a>
					</div>
					<div>
						<a href={ templ.SafeURL(routeFor(ctx, "heatmap")) }>
							@IconFor("heatmap")
							<span class="autohide">{ i18n(ctx, "Heatmap") }</span>
						</a>
					</div>
				</div>
				<div class="flex flex-wrap md:min-w-[400px] justify-end">
					if currentUser.Admin {
						<div>
							<a href={ templ.SafeURL(routeFor(ctx, "admin")) }>
								@IconFor("admin")
								<span class="autohide">{ i18n(ctx, "Manage") }</span>
							</a>
						</div>
					}
					<div>
						<a href={ templ.SafeURL(routeFor(ctx, "user-profile")) }>
							@IconFor("user-profile")
							{ currentUser.Name }
						</a>
					</div>
					<div class="-mr-5">
						<a href={ templ.SafeURL(routeFor(ctx, "user-signout")) }>
							@IconFor("user-signout")
							<span class="autohide">{ i18n(ctx, "Logout") }</span>
						</a>
					</div>
				</div>
			</div>
		} else {
			<div class="md:grow flex flex-wrap justify-end md:justify-start"></div>
		}
		if currentUser == nil || currentUser.Profile.Language == "" ||  currentUser.Profile.Language == "browser" {
			<div
				class="flex flex-wrap md:min-w-[400px] justify-end mt-3 md:mt-0 pt-3 md:pt-0 border-neutral-500 border-t-2 md:border-t-0"
			>
				@Language()
			</div>
		}
	</div>
	@Alerts()
	@Version()
}

templ Test() {
	<!DOCTYPE html>
	<html>
		<head>
			<script src={ routeFor(ctx, "assets") + "/dist/leaflet.js" }></script>
			<script src={ routeFor(ctx, "assets") + "/dist/simpleheat.js" }></script>
			<script src={ routeFor(ctx, "assets") + "/dist/leaflet-heat.js" }></script>
			<script src={ routeFor(ctx, "assets") + "/dist/leaflet.markercluster.js" }></script>
			<link href={ routeFor(ctx, "assets") + "/dist/leaflet.css" } rel="stylesheet"/>
			<link
				href={ routeFor(ctx, "assets") + "/dist/MarkerCluster.css" }
				rel="stylesheet"
			/>
			<link
				href={ routeFor(ctx, "assets") + "/dist/MarkerCluster.Default.css" }
				rel="stylesheet"
			/>
			@Head()
		</head>
		<body>
			@Header()
			<div class="content">
				@SnippetDate(time.Now())
			</div>
			@Footer()
		</body>
	</html>
}
